<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Voted Flats</title>
<style>
  /* =======================
     GLOBAL STYLES 
  ======================= */
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background-color: #f0f2f5;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    flex-direction: column;
    /* ‚≠ê STANDARDIZATION: Body Max Width (600px) ‚≠ê */
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  /* ‚≠ê STANDARDIZATION: Ribbon Styles ‚≠ê */
  .ribbon {
    width: 100%;
    max-width: 600px; /* Standardized Ribbon Max Width */
    height: 60px; /* Standardized Ribbon Height */
    background: linear-gradient(to bottom, #FF9933 33.33%, #FFFFFF 66.66%, #138808 100%);
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #0000FF;
    font-size: 1.8rem; /* Standardized Title Size */
    font-weight: bold;
    text-transform: uppercase;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    white-space: nowrap;
  }

  .ribbon h1 {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
    color: #0000FF;
    font-size: 1.8rem;
    text-transform: uppercase;
  }

  .chakra {
    width: 40px;
    height: 40px;
    animation: spinChakra 10s linear infinite;
    transform-origin: 50% 50%;
  }

  @keyframes spinChakra {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }
  
  /* Rainbow SIVA text aligned to match ribbon font */
  .ribbon .siva-text {
      font-weight: 500;
      font-size: 2.2rem;
      background: linear-gradient(270deg, gold, orange, yellow, green, blue, indigo, violet, gold);
      background-size: 400% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
      margin-left: 6px;
      white-space: nowrap;
      animation: rainbow 6s ease infinite;
  }

  @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; } 
      100% { background-position: 0% 50%; }
  }
  
  .container {
    text-align: center;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
    /* ‚≠ê STANDARDIZATION: Container Max Width (100% of 600px) ‚≠ê */
    max-width: 100%;
    width: 90%;
    /* Adjusted margin to clear 60px ribbon */
    margin-top: 100px;
    margin-bottom: 20px;
  }

  .container h1 {
    color: #333;
    margin-bottom: 1.5rem;
  }

  /* Flats display and columns */
  #flats-display-area { 
    display: flex; 
    flex-wrap: nowrap; 
    justify-content: flex-start; 
    gap: 1.5rem; 
    margin-top: 1.5rem; 
    max-height: 60vh; 
    overflow-y: auto; 
    overflow-x: auto; 
    padding-right: 0.5rem; 
    padding-bottom: 1rem; 
  }
  .flat-column { 
    flex: 0 0 auto; 
    min-width: 120px; 
    background-color: #e9ecef; 
    padding: 1rem; 
    border-radius: 10px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    max-height: 55vh; 
    overflow-y: auto; 
  }
  .column-header { font-size: 1.3rem; font-weight: bold; color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #adb5bd; width: 100%; text-align: center; flex-shrink: 0; }
  .flat-item-dynamic { padding: 4px 10px; font-size: 1rem; color: #333; font-weight: 500; text-align: center; width: 100%; white-space: nowrap; }

  /* Buttons */
  .action-bar { display: flex; justify-content: center; gap: 15px; margin-top: 2rem; }
  .btn { display: block; width: 200px; padding: 1rem; color: white; text-align: center; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; transition: background-color 0.3s; }
  .btn-back { background-color: #007bff; }
  .btn-print { background-color: #28a745; }

  .message { margin-top: 1rem; font-size: 1.2rem; color: #777; }
  .hidden { display: none; }

  /* Flash messages & alerts */
  .status-alert { padding: 15px; margin-bottom: 25px; border-radius: 8px; font-size: 1.1em; font-weight: 600; text-align: center; }
  .alert-closed { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .alert-not-started { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
  @keyframes blink { 0%,100%{background-color:#f8d7da;border-color:#f5c6cb;color:#721c24;}50%{background-color:#dc3545;color:white;} }
  
  .flash-alert { padding:15px;margin-top:10px;border-radius:8px;font-weight:bold;text-align:center;background-color:#f8d7da;border:1px solid #f5c6cb;color:#721c24; }
  .flash-alert.blink { animation: blink 0.5s step-start infinite; }
  .flashed-messages-wrapper { width:100%; max-width:90%; position:fixed; top:90px; left:50%; transform:translateX(-50%); z-index:1001; }

  /* Print grid */
  #print-grid-container { display: none; }

  /* =======================
     PRINT/PDF STYLES
  ======================= */
  @media print {
    body { background-color:white; }

    /* Hide non-PDF elements */
    .ribbon, #flats-display-area, .action-bar, .message, .status-alert, .flashed-messages-wrapper { display:none; }

    /* Adjust container to prevent gold border overlap */
    .container {
      display:block;
      margin: 1cm 1cm 3cm 1cm; /* extra bottom space for border */
      padding: 1.5cm;
      max-width:100%;
      box-shadow:none;
      border:none;
    }

    /* PDF title dynamic */
    .container h1 {
      display:block;
      font-size:26pt !important;
      color:#D84315 !important;
      font-weight:700 !important;
      text-align:center;
      margin-bottom:25px;
    }

    /* Print grid table */
    #print-grid-container { display:block; margin-top:20px; }
    #print-grid-table { width:100%; border-collapse:collapse; font-size:9px; }
    #print-grid-table th, #print-grid-table td { border:1px solid #aaa; padding:3px; text-align:center; height:18px; }
    #print-grid-table th { background-color:#f2f2f2; font-weight:bold; }
    
    /* FIX: Color Codes for Print Grid */
    .voted-cell { background-color:#15d41c !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; } /* Green */
    .disallowed-cell { background-color: #ff5757 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; } /* Red */
    .non-existent-cell { background-color:#f0f0f0 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; } /* Gray */

    /* Gold border */
    .print-border-wrapper {
      display:block;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      border:8px double #DAA520;
      z-index:-1;
    }
  }
</style>

</head>
<body>
  <div class="ribbon">
    <h1>
        <svg class="chakra" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <circle cx="50" cy="50" r="48" stroke="#0000FF" stroke-width="4" fill="none"/>
          <g stroke="#0000FF" stroke-width="2">
            <g transform="translate(50,50)">
              <circle r="3" fill="#0000FF"/>
              <defs>
                <line id="spoke" y1="3" y2="-47"/>
              </defs>
              {% for i in range(0, 360, 15) %}
                <use href="#spoke" transform="rotate({{ i }})"/>
              {% endfor %}
            </g>
          </g>
        </svg>
    {% if voting_status == 'CLOSED' %}
      Post-Election Voter Audit - <span class="siva-text">SIVA</span>
    {% else %}
      Pre-Election Audit (NO VOTES CAST) - <span class="siva-text">SIVA</span>
    {% endif %}
    </h1>
  </div>

  <div class="flashed-messages-wrapper">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes" style="list-style: none; padding: 0;">
          {% for category, message in messages %}
            {% set alert_class = 'flash-alert' %}
            {% if category == 'danger' or category == 'error' or 'DEBUG:' in message %}
              {% set alert_class = alert_class + ' blink' %}
            {% endif %}
            <div class="{{ alert_class }}" role="alert" id="flash-message-{{ loop.index }}">
              {{ message }}
            </div>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
  </div>

  <div class="container">
    <h1>{{ society_name }} - Voted Flats by Tower</h1>

    {% if voting_status == 'CLOSED' %}
      <div class="status-alert alert-closed">
        ‚úÖ **Post-Election Audit.** This list shows the flats that successfully cast a vote.
      </div>
    {% elif voting_status == 'NOT_STARTED' %}
      <div class="status-alert alert-not-started">
        üöß **Pre-Election Audit.** This list should be **EMPTY**. It verifies the system is ready, with no votes recorded.
      </div>
    {% endif %}
    
    <p class="message" id="loading-message">
      {% if voting_status == 'CLOSED' %}
        Loading final vote audit data...
      {% else %}
        Loading pre-election audit data... (Expected to be empty)
      {% endif %}
    </p>

    <div id="flats-display-area"></div>

    <div id="print-grid-container">
      <h1></h1>
    </div>

    <div class="action-bar">
      <button type="button" class="btn btn-print" onclick="printPage()">Print Grid</button>
      <a href="{{ url_for('admin_panel') }}" class="btn btn-back">Back to Admin Panel</a>
    </div>
  </div>

  <div class="text-container" style="display:none;">VPchaya</div>

  <script>
    // Print function
    function printPage() { window.print(); }

    // DOM Content Loaded event
    document.addEventListener('DOMContentLoaded', function() {
      const flatsDisplayArea = document.getElementById('flats-display-area');
      const loadingMessage = document.getElementById('loading-message');
      const printGridContainer = document.getElementById('print-grid-container');

      // Fetch flats data and display it
      fetch('/get-voted-flats-data').then(res => res.json()).then(data => {
        loadingMessage.classList.add('hidden');
        if (!data || data.length === 0) {
          flatsDisplayArea.innerHTML = '<p class="message">No voted flats found. This list is empty, which is expected before the election or normal after a successful election.</p>';
          return;
        }

        // Group flats by tower and display them
        const groupedFlats = {};
        data.forEach(flatString => {
          const key = String(flatString).split('-')[0].toUpperCase();
          if (!groupedFlats[key]) groupedFlats[key] = [];
          groupedFlats[key].push(flatString);
        });

        const sortedKeys = Object.keys(groupedFlats).sort();
        sortedKeys.forEach(key => {
          const columnDiv = document.createElement('div');
          columnDiv.className = 'flat-column';
          const columnHeader = document.createElement('div');
          columnHeader.className = 'column-header';
          columnHeader.textContent = `${key} Tower`;
          columnDiv.appendChild(columnHeader);
          groupedFlats[key].sort().forEach(flatString => {
            const flatItem = document.createElement('div');
            flatItem.className = 'flat-item-dynamic';
            flatItem.textContent = flatString.split('-').slice(1).join('-');
            columnDiv.appendChild(flatItem);
          });
          flatsDisplayArea.appendChild(columnDiv);
        });
      }).catch(err => {
        loadingMessage.textContent = `Error loading data: ${err.message}`;
        loadingMessage.style.color = 'red';
      });

      // Print grid setup
      fetch('/get-voted-flats-grid-data')
        .then(response => response.json())
        .then(gridData => {
          // ‚≠ê FIX 1A: Include disallowed_flats in destructuring (ADDED) ‚≠ê
          const { towers, all_possible_flats, existing_flats, voted_flats, disallowed_flats } = gridData;

          if (!towers || towers.length === 0) return;

          const existingSet = new Set(existing_flats);
          const votedSet = new Set(voted_flats);
          // ‚≠ê FIX 1B: Define disallowedSet (ADDED) ‚≠ê
          const disallowedSet = new Set(disallowed_flats);

          const table = document.createElement('table');
          table.id = 'print-grid-table';

          const thead = table.createTHead();
          const headerRow = thead.insertRow();
          headerRow.insertCell().textContent = 'Flat #';
          towers.forEach(tower => {
            const th = document.createElement('th');
            th.textContent = tower;
            headerRow.appendChild(th);
          });

          const tbody = table.createTBody();
          all_possible_flats.forEach(flatNumberStr => {
            const row = tbody.insertRow();
            row.insertCell().textContent = flatNumberStr;

            towers.forEach(tower => {
              const cell = row.insertCell();
              const flatIdentifier = `${tower}-${flatNumberStr}`;

              // Update cell logic based on voted and existing flats
              if (votedSet.has(flatIdentifier)) {
                cell.classList.add('voted-cell');
              // ‚≠ê FIX 2: Check for disallowed/admin-blocked flats (ADDED) ‚≠ê
              } else if (disallowedSet.has(flatIdentifier)) {
                cell.classList.add('disallowed-cell');
              } else if (existingSet.has(flatIdentifier)) {
                // Leave cell empty for non-voting flats
              } else {
                cell.classList.add('non-existent-cell');
              }
            });
          });

          printGridContainer.appendChild(table);
        })
        .catch(error => console.error('Error fetching grid data for printing:', error));

      // Stop blinking after 5 seconds
      const blinkingAlerts = document.querySelectorAll('.flash-alert.blink');
      blinkingAlerts.forEach(alert => {
        setTimeout(() => {
          alert.classList.remove('blink');
          alert.style.animation = 'none';
        }, 5000); 
      });
    });
     ¬† ¬†
    // ‚≠ê ADDED: Back Button Prevention Function
    function disableBackButton() {
        // Replace current history entry to prevent returning to the page *before* this one
        history.replaceState(null, document.title, location.href); 
        
        // Listen for the back button event, and force them to stay on the page.
        window.addEventListener('popstate', function () {
            history.pushState(null, document.title, location.href);
        });
    }
    // ‚≠ê ADDED: Call the function immediately
    disableBackButton();

    ¬† ¬† document.addEventListener('contextmenu', e => e.preventDefault());
    ¬† ¬† document.addEventListener('keydown', e => {
      if (
        e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(e.key.toUpperCase())) ||
        (e.ctrlKey && e.key.toUpperCase() === "U")
      ) e.preventDefault();
    });

  </script>
 
  <footer class="fixed bottom-2 left-1/2 transform -translate-x-1/2 text-lg text-gray-500 select-none pointer-events-auto z-50">
    Designed/Developed by: 
    <a href="mailto:vpchaya@gmail.com" style="color: #0000FF;" class="underline hover:text-blue-700">
      vpchaya@gmail.com
    </a>
  </footer>
</body>
</html>